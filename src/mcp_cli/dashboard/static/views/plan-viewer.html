<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan Viewer</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
:root {
  --dash-bg: #1e1e2e; --dash-bg-surface: #262637; --dash-bg-hover: #2e2e42;
  --dash-fg: #e0e0e0; --dash-fg-muted: #888899;
  --dash-accent: #7aa2f7; --dash-success: #9ece6a; --dash-warning: #e0af68;
  --dash-error: #f7768e; --dash-info: #7dcfff; --dash-border: #3b3b52;
  --dash-font-mono: 'JetBrains Mono','Fira Code',monospace;
  --dash-font-ui: 'Inter',-apple-system,sans-serif;
  --dash-font-size: 13px; --dash-radius: 6px; --dash-spacing: 8px;
}
body {
  background: var(--dash-bg);
  color: var(--dash-fg);
  font-family: var(--dash-font-ui);
  font-size: var(--dash-font-size);
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* Plan header */
#plan-header {
  padding: 8px 12px;
  background: var(--dash-bg-surface);
  border-bottom: 1px solid var(--dash-border);
  flex-shrink: 0;
}
#plan-title {
  font-size: 14px;
  font-weight: 600;
}
#plan-status {
  font-size: 11px;
  color: var(--dash-fg-muted);
  margin-top: 2px;
}
.plan-status-badge {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
}
.plan-status-badge.running { background: var(--dash-accent); color: var(--dash-bg); }
.plan-status-badge.complete { background: var(--dash-success); color: var(--dash-bg); }
.plan-status-badge.failed { background: var(--dash-error); color: var(--dash-bg); }
.plan-status-badge.pending { background: var(--dash-fg-muted); color: var(--dash-bg); }

/* Steps list */
#steps {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
#steps::-webkit-scrollbar { width: 6px; }
#steps::-webkit-scrollbar-track { background: transparent; }
#steps::-webkit-scrollbar-thumb { background: var(--dash-border); border-radius: 3px; }

/* Step card */
.step-card {
  background: var(--dash-bg-surface);
  border: 1px solid var(--dash-border);
  border-radius: var(--dash-radius);
  padding: 8px 10px;
  display: flex;
  gap: 10px;
  align-items: flex-start;
}
.step-card.running {
  border-left: 3px solid var(--dash-accent);
  background: var(--dash-bg-hover);
}
.step-card.complete { border-left: 3px solid var(--dash-success); }
.step-card.failed   { border-left: 3px solid var(--dash-error); }
.step-card.pending   { border-left: 3px solid var(--dash-border); }
.step-card.skipped   { border-left: 3px solid var(--dash-fg-muted); opacity: 0.6; }

.step-icon {
  font-size: 14px;
  width: 20px;
  text-align: center;
  flex-shrink: 0;
  line-height: 1.4;
}
.step-body { flex: 1; min-width: 0; }
.step-title {
  font-size: 12px;
  font-weight: 500;
  margin-bottom: 2px;
}
.step-meta {
  font-size: 11px;
  color: var(--dash-fg-muted);
  display: flex;
  gap: 8px;
}
.step-tool {
  font-family: var(--dash-font-mono);
  color: var(--dash-accent);
}
.step-duration { color: var(--dash-fg-muted); }
.step-error {
  font-size: 11px;
  color: var(--dash-error);
  margin-top: 4px;
}

/* Progress bar */
#progress-bar {
  height: 3px;
  background: var(--dash-border);
  flex-shrink: 0;
}
#progress-fill {
  height: 100%;
  background: var(--dash-accent);
  transition: width 0.3s ease;
  width: 0%;
}

/* Empty state */
.empty-state {
  display: flex;
  align-items: center;
  justify-content: center;
  flex: 1;
  color: var(--dash-fg-muted);
  font-size: 12px;
  text-align: center;
  padding: 24px;
}

/* Spinner animation for running step */
@keyframes spin { to { transform: rotate(360deg); } }
.step-card.running .step-icon { animation: spin 1s linear infinite; }

/* ── Responsive: narrow panel / small screen ──────────────────── */
#steps {
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

@media (max-width: 400px) {
  #plan-header { padding: 6px 8px; }
  #plan-title { font-size: 13px; }
  #plan-status { font-size: 10px; }
  .plan-status-badge { font-size: 9px; padding: 1px 4px; }
  .step-card { padding: 6px 8px; gap: 6px; }
  .step-icon { font-size: 12px; width: 16px; }
  .step-title { font-size: 11px; }
  .step-meta { flex-direction: column; gap: 2px; font-size: 10px; }
  .step-error { font-size: 10px; }
  #steps { padding: 6px; gap: 3px; }
}

@media (max-width: 280px) {
  .step-meta { display: none; }
}
</style>
</head>
<body>

<div id="plan-header" style="display:none">
  <div id="plan-title">Plan</div>
  <div id="plan-status"></div>
</div>
<div id="progress-bar" style="display:none"><div id="progress-fill"></div></div>

<div id="steps">
  <div class="empty-state">No plan running. Use --plan-tools to enable planning.</div>
</div>

<script>
'use strict';

const PROTOCOL = 'mcp-dashboard';
const VERSION  = 1;

const stepsEl      = document.getElementById('steps');
const headerEl     = document.getElementById('plan-header');
const titleEl      = document.getElementById('plan-title');
const statusEl     = document.getElementById('plan-status');
const progressBar  = document.getElementById('progress-bar');
const progressFill = document.getElementById('progress-fill');

let currentPlan = null;

// ── postMessage handler ─────────────────────────────────────────
window.addEventListener('message', (evt) => {
  const msg = evt.data;
  if (!msg || msg.protocol !== PROTOCOL) return;

  switch (msg.type) {
    case 'INIT':
      applyTheme(msg.payload.theme || {});
      sendReady();
      break;
    case 'THEME':
      applyTheme(msg.payload);
      break;
    case 'PLAN_UPDATE':
      handlePlanUpdate(msg.payload);
      break;
  }
});

function getShell() {
  if (window.parent !== window) return window.parent;
  if (window.opener) return window.opener;
  return null;
}

function sendReady() {
  const shell = getShell();
  if (!shell) return;
  shell.postMessage({
    protocol: PROTOCOL, version: VERSION,
    type: 'READY',
    payload: { name: 'Plan Viewer', icon: 'plan', accepts: ['PLAN_UPDATE'], version: 1 }
  }, '*');
}

// ── Theme ───────────────────────────────────────────────────────
function applyTheme(t) {
  const r = document.documentElement;
  const set = (k, v) => v && r.style.setProperty(k, v);
  set('--dash-bg', t.bg); set('--dash-bg-surface', t.bg_surface);
  set('--dash-bg-hover', t.bg_hover); set('--dash-fg', t.fg);
  set('--dash-fg-muted', t.fg_muted); set('--dash-accent', t.accent);
  set('--dash-success', t.success); set('--dash-warning', t.warning);
  set('--dash-error', t.error); set('--dash-info', t.info);
  set('--dash-border', t.border); set('--dash-font-mono', t.font_mono);
  set('--dash-font-ui', t.font_ui); set('--dash-font-size', t.font_size);
  set('--dash-radius', t.radius); set('--dash-spacing', t.spacing);
}

// ── Plan updates ────────────────────────────────────────────────
function handlePlanUpdate(payload) {
  currentPlan = payload;
  headerEl.style.display = 'block';
  progressBar.style.display = 'block';

  titleEl.textContent = payload.title || 'Plan';

  const steps = payload.steps || [];
  const total = steps.length;
  const completed = steps.filter(s => s.status === 'complete' || s.status === 'failed' || s.status === 'skipped').length;
  const running = steps.filter(s => s.status === 'running').length;

  // Status badge
  const planStatus = payload.status || 'running';
  const safePlanStatus = esc(planStatus).replace(/[^a-z]/g, '');
  statusEl.innerHTML = `<span class="plan-status-badge ${safePlanStatus}">${esc(planStatus)}</span> ${completed}/${total} steps`;

  // Progress bar
  const pct = total > 0 ? (completed / total) * 100 : 0;
  progressFill.style.width = pct + '%';
  if (planStatus === 'complete') progressFill.style.background = 'var(--dash-success)';
  else if (planStatus === 'failed') progressFill.style.background = 'var(--dash-error)';
  else progressFill.style.background = 'var(--dash-accent)';

  // Render steps
  stepsEl.innerHTML = '';
  for (const step of steps) {
    stepsEl.appendChild(buildStepCard(step));
  }
}

function buildStepCard(step) {
  const card = document.createElement('div');
  const status = step.status || 'pending';
  card.className = `step-card ${status}`;

  let icon = '○';
  if (status === 'running')  icon = '◎';
  if (status === 'complete') icon = '✓';
  if (status === 'failed')   icon = '✗';
  if (status === 'skipped')  icon = '−';

  let meta = '';
  if (step.tool) meta += `<span class="step-tool">${esc(step.tool)}</span>`;
  if (step.duration != null) meta += `<span class="step-duration">${Number(step.duration).toFixed(1)}s</span>`;

  let error = '';
  if (step.error) error = `<div class="step-error">${esc(step.error)}</div>`;

  card.innerHTML = `
    <div class="step-icon">${icon}</div>
    <div class="step-body">
      <div class="step-title">${esc(step.title || `Step ${step.index || ''}`)}</div>
      <div class="step-meta">${meta}</div>
      ${error}
    </div>
  `;

  return card;
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

sendReady();
</script>
</body>
</html>
